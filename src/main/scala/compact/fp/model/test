#include <cstdio>
#include <cstdlib>
#include <omp.h>

// Serial matrix-vector multiplication (for verification)
void SerialResultCalculation(const double* pMatrix, const double* pVector,
                             double* pResult, int Size) {
    for (int i = 0; i < Size; i++) {
        pResult[i] = 0.0;
        for (int j = 0; j < Size; j++) {
            pResult[i] += pMatrix[i * Size + j] * pVector[j];
        }
    }
}

// Parallel matrix-vector multiplication
void ParallelResultCalculation(double* pMatrix, double* pVector,
                               double* pResult, int Size) {
    int i;
#pragma omp parallel for private(i) schedule(static)
    for (i = 0; i < Size; i++) {
        pResult[i] = 0.0;                    // Important: reset before accumulation
        for (int j = 0; j < Size; j++) {
            pResult[i] += pMatrix[i * Size + j] * pVector[j];
        }
    }
}

// Test correctness by comparing with serial version
void TestResult(const double* pMatrix, const double* pVector,
                const double* pResult, int Size) {
    double* pSerialResult = new double[Size];
    SerialResultCalculation(pMatrix, pVector, pSerialResult, Size);

    bool equal = true;
    for (int i = 0; i < Size; i++) {
        if (pResult[i] != pSerialResult[i]) {
            equal = false;
            break;
        }
    }

    if (equal)
        printf("The results of serial and parallel algorithms are identical.\n");
    else
        printf("The results of serial and parallel algorithms are NOT identical. Check your code.\n");

    delete[] pSerialResult;
}

// Simple dummy initialization (replace with your real one if needed)
void ProcessInitialization(double*& pMatrix, double*& pVector,
                           double*& pResult, int Size) {
    pMatrix = new double[Size * Size];
    pVector = new double[Size];
    pResult = new double[Size];

    // Fill with some data
    for (int i = 0; i < Size; i++) {
        pVector[i] = 1.0;
        pResult[i] = 0.0;
        for (int j = 0; j < Size; j++) {
            pMatrix[i * Size + j] = i + j;
        }
    }
}

int main() {
    int Size = 1000;  // Change as needed

    double *pMatrix = nullptr, *pVector = nullptr, *pResult = nullptr;

    ProcessInitialization(pMatrix, pVector, pResult, Size);

    double Start = omp_get_wtime();
    ParallelResultCalculation(pMatrix, pVector, pResult, Size);
    double Finish = omp_get_wtime();
    double Duration = Finish - Start;

    TestResult(pMatrix, pVector, pResult, Size);
    printf("Time of parallel execution = %f seconds\n", Duration);

    delete[] pMatrix;
    delete[] pVector;
    delete[] pResult;

    return 0;
}